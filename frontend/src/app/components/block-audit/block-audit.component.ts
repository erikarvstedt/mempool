import { ChangeDetectionStrategy, Component, OnInit } from '@angular/core';
import { Router } from '@angular/router';
import { BlockAudit, BlockExtended, TransactionStripped } from 'src/app/interfaces/node-api.interface';
import { StateService } from 'src/app/services/state.service';
import { detectWebGL } from 'src/app/shared/graphs.utils';
import { RelativeUrlPipe } from 'src/app/shared/pipes/relative-url/relative-url.pipe';

@Component({
  selector: 'app-block-audit',
  templateUrl: './block-audit.component.html',
  styleUrls: ['./block-audit.component.scss'],
  styles: [`
    .loadingGraphs {
      position: absolute;
      top: 50%;
      left: calc(50% - 15px);
      z-index: 100;
    }
  `],
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class BlockAuditComponent implements OnInit {
  block: BlockExtended = undefined;
  blockAudit: BlockAudit = undefined;
  transactions: string[];

  paginationMaxSize: number;
  page = 1;
  itemsPerPage: number;

  show: 'missing' | 'added' = 'missing';
  isLoading = false;
  webGlEnabled = true;
  isMobile = window.innerWidth <= 767.98;

  constructor(
    public stateService: StateService,
    private router: Router,
  ) {
    this.webGlEnabled = detectWebGL();

    this.block = {
      id: '0000000000000000000591b90d6a6df6808c448f4565556d419d56ebec79b606',
      height: 742845,
      version: 0x27e94000,
      timestamp: 1656501837,
      bits: 0x170984cc,
      nonce: 0xa66504b,
      difficulty: 29570168636357.99,
      merkle_root: 'bb06dfa7642eef5b31b6b39d703ad5635127842d7e660e3199c0fdb8254abe8c',
      tx_count: 333,
      size: 251982,
      weight: 544938,
      previousblockhash: '00000000000000000001f936e2452eada68c91af448a72b56cc25142cc9204de',
      extras: {
        totalFees: 1577167,
        medianFee: 10,
        feeRange: [1,2,5,10,11,17,155],
        reward: 626577167,
        coinbaseRaw: '03bc550b044d36bc622f466f756e6472792055534120506f6f6c202364726f70676f6c642f16190d0e5000000000000000',
        pool: {
          id: 111,
          name: 'Foundry USA',
          slug: 'foundryusd',
        }
      }
    };

    this.blockAudit = {
      matchRate: 61.86,
      missingTxs: ["b3ea973175d1e43d14219db38f48b0839fef4bb4108738ef128b76d4147da200","21928d931ddbc5519e690268e691ca0154385377c00c4c2fb8aa5e4125f3ef32","c6717d39ae829c25062048080c05686e7192f1a88b9ba9260dc31217ee61f755","1181f3570d1b46c614903936f940b47619339e22f8364b969391743e5dc74277","53346ab7a3c9f920d52e105b4216770578176b43225acc207b7ab8d09d42e156","cd0c4ba11bc21a468c157963b06af29f77c7f769b4fd1206d5dcfb7a63056039","b27f88b1acd5e7cc173e576d3fd150c824ad8dcc6e7d28cbbcbba145f3f02597","3971e0aa1af8f373d26a77860dc734596570b6d93cd896c93b528beae9b08ec9","9682594c9cf923515da0e99df75e2309abb33f380cdc0c1915b04d9feefa7255","94143724d14bbd8ad688d31053837833bd85a1af2499b6c9573d9c2eb037e0c9","e7f46c7034b4af29a242a8ce15638669732b048c208fa310e9377553edc81f16","ccc6bc074761221dbb7d2e1bfced3d79bfe0c11d018f98842e7eabc3f16bf76c","c2166b2cc603d12f2041ca1bd5cf6dc36f33e9f82e88d635cac8b6815528e78d","5a182c8a06e0240a6380318de335bbade7b22bd6f34aba67b191c4ceefc950ef","2e42e786a54027f169fd7fb534412a4eed8fc2911ea7e66e3c0c8c609de543aa","5015d25d1e21a7555282ac65e6b5d11a18df7e245e51626bc71619aa8d592274","751edeeacf1f182f90652541ce2929355eae4238830da0a9801605c5eb2f037f","3be965e0d56e841947c103c1c31debdd5f5470a094b3ee5c499165d0d34b5880","29837db8eb14650b55e0610e6a5fdc36d26a0ac93118d7b0d3dfc9ee07707555","164ae51cbd35d887c726922e2efa2f5fa68652fd56dad38aff0c1dbcbfb720f6","6af0c045b7df4c7f2d6b32ac11033b4258204b97a4909d7e39854e92ef9867f2","d6b0253f491151e03a918551e8e2d84e57099b8960d83828430bf057d2b973cd","82e91f9392d95ec849fe9e7815ea6f7c28d2a89cdb88f8df64905cc868cd30ca","61c6d104ea1446e464e51bf9abcfe32534cd1df82d2cfed578b2039e77c1cf24","391029aba713252e8d20807529ec8a8186a72036e66504bdecce810bd4a66467","917b232c8cd7e54e28899a4ce68c25ebcfaf2b2c7927e5b49abf1b918721f7d4","ec0385245b5e0c86e67606469c2efc363d45fb09287c99d5e5fd6c02d86d2ff7","fee52d320bcce6fa2e0bae8da5277fd412d6ad505ee9b947c513746830c65a7a","0df6e3104af31e854cdab7bb5017a64bb6373e7814250d228bcb7004c50df2db","87aae4b08f602e4675fe52ea719c61eca0ad365df2d8e20ce1803b7ac45a76cd","a7778005a545a13185a80e32d4e2117d4a610c782edb486c36272d9f88619373","72de44d79415eb9b7e07c201eeba33a76793c5c0cf62a59df27d78e7c4690409","af061c7c636a85b1b35cf4c60081a904af1bf04da118dd11569f6c465da25241","d33f64414bf4dd538bda5275289f1296c5f9165993cd671c5ea7ab5567bb753a","64aa015ed22756544c0b4ebdf5b9874a5e410a2bf65ff30b6dcc784cc7a3ad7e","33ad20eafecf96e99380955599c4ef1e7de3fa4543c5c2d9a6eec9aa38ae8c6b","1a9e9e1de09ea91fc81bd5f9302c3f00748adace13122af6773ea564fa185bdf","446f3919b48607f2169a82505b17b30725ebb6df51239820726207cf9519c331","ccc414a89f01023eaa7ca2c4acd030c1be92cd1997ee5c82c985f1ed08ad8d10","31948d48311686815f2d7e37000d15b15f8c39711607d9ac1d6d2658955d786a","df8382b42a552e47e1f2d604b1b67d220a4a992e5dd3b7863846cc997cc3d77a","ed5ca1523181fb7032ad24a4dc72b1a5824776a8feac72955623d9f7e01eaf7a","42062ec6024903fab13c2309bbc8d94b37b3302a5314f40e54840c33cbaf7919","98a8e4616edf5219736299687ce744f7297d517fdad53c7f230201a6e24eed4e","d54b96fd9d4fa3742a23a85cc1c2779b93968916b000f2be212f5a91159eb9cb","538b7d0f10c156ddb0c22f88eefe34402add790e2ba80951bc2b81cf886f367b","1eb4746fa8b208eadd4e48bf0418495cf1c04c87800dc2d041a13eecd4eaab3a","057c6d76e7f89b75ed593425c69533b702c5cf3bd76e9c8b199bf98e8abefad6","a683bafe2c1c66dc5460d39d4142196005a493d2134a5a92c9c68c0c0d0430d9","4584407fdea2bc21c9c32fb3eb4caee46ca6bd57f761922047df7ac94da4fdde","c42b766fa808cd5b17ae96e849f2db81cc19c84c778a99517a28a36728dad222","001edfd89a50cffabbf63dbc07127e3020d6435a506d52360e24a9e9e19329cf","cad93bd888d212304cb85dadc484172e98aee8517c4466209436526ba560425c","9948013848a8eaf819d252f8ef63bc38ff440a92df7f8d7a1dff658476bcd311","c6e1addcf17632f8144e0e2751e55e6e9e084e0809c82c33fc69358b1ac6b29a","40934f67cbe81ddedcc770e48458bef31023f54c61bc5d2066590cab14af2b95","8a2ed0276681b141c507bba426eb45708f7cf699c849a20d5bcea813b82f8c79","7b543b37f56604aa024fd3ddd6d832194ebcacae7f7764c750bbe72f8118665e","6b1da79256ef52583155cb9f57761739b4c771f4a08a46e12dc3ca13932e82c7","9a2a010967c0b24873e0fb5858546e8a9476449acf651a8fa95e1516d7d40a56","ffe4d14226c261517f1fd5127785046e0e2c1ccadc48524ab50a1aa9dfe09551","6e9c95e100bb109ac4cb767a74478cac38e80577f00b0d34a1df661f0e8f7be5","ee0db4f65db6e296c5579cd50b32b5575b795703265af9aaeffa12f3c299d796","4e76e0611f294d06b65c008c7d47b9f13e24aa8d9e3e7fac13ca5bd09192debe","4a41d0bbaf156780b07dc6b3ffa8d396bdd547da260db7cb71c4c89f2c0c27b8","dc53bad5d53acac5e2f47076c8308a24778846d5ff3d96e000c88e2f139a94b5","359ba574a5b5b9b26538d61d95a22b51a0f63ddffa13ef4a962e4ef4ef84a6e6","593dd09cf0ae2514975d501deb45e168d99b245c20876018170ac97c78104cde","6e1991c1ca28e9a8c5c43188178ff83f4703e72100b3c1404608ff2b9a1cc776","db38019ac978b45af96bed6a88e39256ff972bba936827579d7e6970316282c6","2aff27aeb6db8fa97054dada39b18b887a2ef9d3ac05bd1c1421e986b7362468","cf598777d4f03679165370b2a16ddcb0b48cd84f01190aed114860e29d5cb5ba","750112a645d027890cc4afb7624c7cbd7d3feeb1671a4766234218583e1daa48","fa6882f9cc780bbbaa80f7f71fc9477b0591fb29638f65ef4cde27c177885d47","192d1d81ad097044877c2d23c80e309011a1a405416138ca766aa5138a5a55e0","956d2261d95c5e7a36ddaa664efb12fc40645f2af2ff3dbb7a84460a39788017","f074088f3e791b985ba8a6762c5e9f40f69bf539b7bcb23e2bec754e947c724b","7e79e04a2b78c7f336ca7d6e1d10bffd5aeeef85af1172b6c0cf60ea2031ac2d","35891f79e213b6c3d11c30369d49bb119baab078d72ab2351c0447c1a5d2900e","5a7bba94a6e2a5847826881cb49a0f5e2bc1909874bddd2503ebf6d294663735","693ac0b1bf5637012a6ae3b6f94e0c419995f7fa3e92f35a296b77618d3b7a53","f724357804d28a9603161465c49e393059cf5a165a1ebdfd686d4c169ddd4ba3","4745d8395127b1bd6b61f041f72e4ea13d1c721f1b87e482b0b689a94a870265","4aa0b19803499a7e9baa7529e663ad5caa4966fcdc01f2055e8ebda6e9e9656a","ce4f3ffbb8038af06a24c1d96483d361f67abf738f13168a49d38e917fd3882d","a2a2af61ddda05ee716957d6143718387e5fa3c21a0046b46015f6a27560b975","4a2be777de3c93f5e6e9dba3962ee3b4e39e040f045b9a00c4071909d047f3b0","f3c359decc8c76480ee3ec93236f2a9e09cc83fd486e7bacba35f52ca9b7aaf5","89ae11681a874b045a6c6918587dfef6eb286219e4fe4d195e3d5e20a293e876","954b0f12df5f91bba5aea5d2093837c97b8e90d2cd739e921af8adc670ee3fc3","65486429ac7a6617625eb1cf99512182d008940b4550b51554bdea69c46d11f8","524cefbeb42bc791268ca052254b268b796a4e4c9e9726428eeca806ecf1bbe6","ec1be073367ea0d450220f93e3583fc4e6a97480ebccc906a3cf911267992982","7cf60123ec3d84d758e4698c2955df5cef855d756b3106a4b157a4dafa4e90dd","a4f90718d88f64c3ff6e067be47d654d52b7f51c0c82b6afb416c72af6798b31","367fc678f781a90e56925c04442bcea92f2aa1d9b15e123b68b944fc445361fd","4826fb7e7ee92b143daf5ea39460b783d97361c567b4fd80f48281700613ea31","4e5b4fbfb2cee91c0074612d5ba647e36206311d74503d421524ecd44135a902","482d8544c559f9dc6e5b70a4c374c6f2fceb8e174525355087abf0d4fb4cdcdf","196b298e965468de1812f123ac391397958586cd47f859567177715394d78943","5b8798d1876a58d5cd9434af71e55791742b133abb53a8ebc7a87e726f9de614","66b3e001b06c1c02030c1f936b32bce8b0c8cfdb468277c0a519864c1be7658b","9766d795bc10309faea6c3a8e75d3578e132fe7ad2ad6fe4fc02482a4e073aef","21caacb090d61f99b6fc4f8c8d47cd5360cffb756865e7c6b7485541ca8ae769","098f6f60066a72a3add84857b4e819d0f52753ad817bbc2808951d608fe1aa03","dc5c7f9e8e9ece5369ddd5453f26eb56457c421bad2fa85313bf7a81dd24faa9","48faf39b2d344e06ebc2f63d772f518700c2d58559e52ff43c219c85f7eeb1ed","47b219d33ae561e23d6b9187fc87c3257d1804c9ea1afe2f12d3219bb08ca295","f7abe46dd2c8d916211c8e2318b91dd06a46285b6632ad40988c4653b3be9f20","5641e86a6edb4e0b79dd600c3c77dc72254d7a938d8f2a87b0e7003d2bfe80ba","67332d18992329901cb6fd84835137def6bedbb49733d47e02fe9d40a553fa49","5c4214e3bc28b110d04476a1ab65257079240890412bb5a5ddf544afe448e39b","b5624c002b096ab30ad133d52ed1fa87be79e671b0ce03acb7013151e37697cd","cd3af9246cab6421f8ed46c4be34c2edca58984fb84f93a64406a0f8728e76ff","7d0c13fa35c375c0bfb68ac46e357de3e5b73780565ac16e29ff280fb9e312e3","fb52068b03260e608ae3a542890508195bfd37ee89653009628cf481a87dacdf","fbec763ea1b9f326d6baa0ec91b2a692aabd18ebbe3ba04c6f4c0ccd72586a52","56ab285fb74e0d80086d4d0cc0ec410291228e5d227bc5cd30bb82c42a134e9a","f6dc221c395d0936f0f2b73e792f7c93b47f8c7e868ec286a7fac8fa09a3db21","2c34ca5cfa6cd0e12d46ef714494407dfdfd0933eece294db341486b8ee6d832","a654eed5efe9e7a8eb66e1612a866353ea2a096e86b92797a3d53d7df906d261"],
      addedTxs: ["ff24b738f2120c3178794af8da6015220017555c7c167e175750910cea257de6","4c597d2f1af7f925f707323e6e88ca0cd0e00988e0337682e463f3a9628726bd","d83567526119211be2bece9766e274cfb0bef805ba6c9cbb3137e2869f3534bc"],
    };
  }

  ngOnInit(): void {
    this.paginationMaxSize = window.matchMedia('(max-width: 670px)').matches ? 3 : 5;
    this.itemsPerPage = this.stateService.env.ITEMS_PER_PAGE;
  }

  onResize(event: any) {
    this.isMobile = event.target.innerWidth <= 767.98;
    this.paginationMaxSize = event.target.innerWidth < 670 ? 3 : 5;
  }

  changeMode(mode: 'missing' | 'added') {
    this.router.navigate([], {fragment: mode});
    this.show = mode;

    if (mode === 'missing') {
      this.transactions = this.blockAudit.missingTxs;
    } else {
      this.transactions = this.blockAudit.addedTxs;
    }
  }

  onTxClick(event: TransactionStripped): void {
    const url = new RelativeUrlPipe(this.stateService).transform(`/tx/${event.txid}`);
    this.router.navigate([url]);
  }

  pageChange(page: number, target: HTMLElement) {
  }
}
